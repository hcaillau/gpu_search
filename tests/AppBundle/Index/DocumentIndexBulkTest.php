<?php

namespace Tests\AppBundle\Controller;

use Tests\AppBundle\WebTestCase;
use AppBundle\Model\SearchResult;
use AppBundle\Form\Data\DocumentSearch;
use AppBundle\Index\DocumentIndex;

/**
 * Test de rÃ©gression sur DocumentIndex
 */
class DocumentIndexBulkTest extends WebTestCase
{

    public function setUp(){
        parent::setUp();
    }

    public function testBulk(){
        $documentIndex = $this->getDocumentIndex();
        $this->getDocumentIndex()->reset();
        $path = dirname(__FILE__).'/../../DATA/sample-bulk-document-full.jsonl';
        $this->assertFileExists($path);
        $documentIndex->bulk($path);
        sleep(2);
        $result = $documentIndex->findAll();
        $this->assertNotNull($result);
        $this->assertEquals(105,$result->getTotal());
    }

    /**
     * search(default) - Recherche avec geoshape uniquement
     */
    public function testSearchGeofilter(){
        $documentIndex = $this->getDocumentIndex();
        $result = $documentIndex->findAll();
        $this->assertNotNull($result);
        $this->assertEquals(105,$result->getTotal());
        $documentSearch = new DocumentSearch();
        $documentSearch->setGeometry("MULTIPOLYGON(((4.61665452672203 46.0905757721889,4.61660210931025 46.0892345081797,4.61626935442555 46.0889240109783,4.613794695769 46.0870858231449,4.61359003535329 46.0867284626531,4.6132443739722 46.0864181405478,4.61226102476257 46.0859907855272,4.61135136162513 46.0858686060566,4.61017527920187 46.0854890040961,4.60950249182586 46.0850572180404,4.60838427806916 46.0844426010884,4.60753301784512 46.0841034012124,4.60686132148717 46.0837076116026,4.6060381473481 46.0825573944437,4.6055087955693 46.0821595821679,4.60392782373667 46.0816505445819,4.60274400380621 46.0810007742705,4.60202483065046 46.0807497357496,4.59994313878259 46.0799324768121,4.5996572094565 46.0798914749924,4.59899269565951 46.0797387211559,4.59824574421415 46.0798663339511,4.59675755843386 46.079427945061,4.5917762450772 46.0794799312619,4.59155615558331 46.0799243487723,4.59116970219385 46.0804341462591,4.59109921641903 46.081128652876,4.59138055301751 46.0814579560012,4.59126291101386 46.0818649088223,4.59051522486691 46.0824157965064,4.58954645033233 46.0824834135927,4.5881830309543 46.082331379283,4.5874041605206 46.0822522121044,4.58648967503324 46.0819587748084,4.58608210748972 46.0817393052819,4.58530220935568 46.0816241113414,4.58530610606276 46.0817591576138,4.58507587451362 46.0823027772162,4.58420263493561 46.0829904770003,4.58369835116685 46.0834568593332,4.58353019271567 46.0839095418998,4.58399964273064 46.0844794184624,4.58394533388841 46.084840445053,4.58401274413161 46.0862805776151,4.58408133195939 46.0864147207381,4.58509169575108 46.0873373087367,4.58657056725121 46.0887937411961,4.58664436514753 46.0891079443345,4.58679580083445 46.0894210617689,4.58744797863498 46.089592074143,4.5880409242519 46.0930873903803,4.58833349805177 46.0938038330517,4.58941919347112 46.0950855994736,4.58959411080434 46.0962089893496,4.5899280620659 46.0965645799832,4.59002134647729 46.0971036762045,4.5905387372911 46.0970874193956,4.59141894740703 46.097975751992,4.59209316272578 46.0989029949639,4.59254645462726 46.1002476437261,4.59250654414283 46.1011038424581,4.5920291996693 46.1020562450518,4.59093329565357 46.1035577205305,4.59055570192389 46.1039322880102,4.58969000531369 46.1048901212159,4.58917749072617 46.105077432406,4.58712394862025 46.1052592795794,4.58699711810054 46.1053511200516,4.58675256036183 46.1058499080677,4.58655971043393 46.1058976373794,4.58541190847675 46.10605778254,4.58529546903957 46.1065097440725,4.58547423737499 46.1077681857702,4.58491510291716 46.1081362623256,4.58381139185402 46.1098269138601,4.58480789081891 46.1102543341671,4.58527394050058 46.1106981617079,4.58548214525417 46.1111816158326,4.58537084226928 46.1113633043792,4.58415174768667 46.111749598228,4.58383332228042 46.1119341753878,4.58377379170746 46.1121151399162,4.58398610342777 46.1122923115954,4.58423205630145 46.1122888794389,4.58438094440259 46.1125119689995,4.58448719119319 46.1135012229974,4.58437852180316 46.1142232755934,4.58408211892411 46.1147227802969,4.58363941427266 46.1150892246453,4.58294969837423 46.1154230848714,4.58230501123602 46.1155221391756,4.58204869217138 46.1156157783371,4.5816774386338 46.1162153929794,4.58157518952306 46.116712185481,4.58171217026573 46.1169714711505,4.582591258782 46.1178148559108,4.58266507291123 46.1181290611814,4.58192458877346 46.118949983516,4.58153749147604 46.1190004099572,4.5815517552719 46.119495579184,4.58121232725002 46.1203019022349,4.58075584801602 46.1210918404569,4.58037574280425 46.1218356801596,4.57990136169385 46.1220044024963,4.57965718849071 46.1229715150453,4.57944900714001 46.1247397209536,4.57922786257338 46.1260577723745,4.57900929727482 46.1270155200625,4.57873530253545 46.1282982782618,4.57840483929546 46.1294197002579,4.58050470124978 46.1317142167272,4.58188496327129 46.1337575285841,4.58251051161884 46.1347845819682,4.58345698722511 46.1357080844632,4.58385069551317 46.1358827281033,4.58449795811816 46.1358646926903,4.5858109505568 46.136467827946,4.58688597747926 46.1373534811344,4.5873649645502 46.1377881154051,4.58750749381463 46.1382364578989,4.58790774502217 46.1386361637798,4.58968969304021 46.1393227650337,4.59128237431899 46.1401831181531,4.5915622898497 46.1408997321359,4.59172695226512 46.1416629942378,4.59205988802587 46.1419735625083,4.59422637232569 46.1425105967733,4.59500872428606 46.1426797472075,4.59781385185902 46.1433428445058,4.60041557309934 46.1436935044505,4.60055936062068 46.143736511977,4.60087021459964 46.1437321311895,4.6009931708866 46.1435052301265,4.60185638866406 46.1424482796047,4.60231364944613 46.1425769307494,4.60281463705247 46.1419844249313,4.60337767866576 46.1417423031376,4.60421691187819 46.141640385519,4.60497927200819 46.1411252382965,4.60530042904664 46.1410306322504,4.60566944024883 46.140800247764,4.60614096520004 46.1409737154669,4.60685172037692 46.1409096218562,4.60709384552102 46.1407710950696,4.60746656963059 46.1402254162357,4.60791432944396 46.1400299366276,4.60899696377216 46.1398344696482,4.60990593146594 46.1399026496359,4.61068301016938 46.13989163213,4.61151004124841 46.139375522659,4.61157083174531 46.1392395588641,4.61212613749963 46.138736306743,4.61282759696057 46.1383570708603,4.61318729686895 46.13781155709,4.61414669242776 46.1373926216702,4.61612201332889 46.13671604313,4.61731946699044 46.1360234894838,4.61972138884754 46.1344400939583,4.62034663618352 46.1341159376068,4.6204721483775 46.1339790451313,4.62116950077012 46.1334647129345,4.62205638252289 46.1332268793298,4.62275770298086 46.1328475820025,4.62359942723493 46.1328355508814,4.62391757377981 46.1326418594565,4.62527727650045 46.1326224075822,4.62557980013549 46.1323388671423,4.62569329627572 46.1317968353054,4.62605682582536 46.1313863251027,4.62650338025453 46.1311547602513,4.62694325986878 46.1306981194962,4.62750474463227 46.1304108631333,4.628861452132 46.1302923357355,4.63031330305459 46.1294518823291,4.63134519184689 46.1293019606475,4.63191958797024 46.1290144964093,4.63256568267069 46.128960175255,4.63281796089346 46.1287313778451,4.63298986751285 46.1284136676495,4.63337296558209 46.1282280215602,4.63369373029245 46.1281243322212,4.63407414399527 46.1278486542493,4.63392367255754 46.1275806153324,4.63365800783691 46.127359267631,4.63378347139277 46.1272223603939,4.6337106921688 46.1269532033386,4.63290237487046 46.1263433607712,4.63126273467268 46.1256553909116,4.63138820030766 46.1255184863075,4.63220615531899 46.125146459097,4.63372523596481 46.124395060756,4.63474736919493 46.1239210017998,4.63538401445325 46.1235515613082,4.64096558163129 46.1209130919052,4.64590362605383 46.1184277807118,4.64654148252256 46.1181032921963,4.64767855049631 46.1175824121769,4.64818422563714 46.117169763982,4.64824084674815 46.1168987365653,4.64789885279181 46.1167235643478,4.6478934486387 46.1165435058797,4.6485889711516 46.115983990238,4.64934464473713 46.1157028085588,4.64933788375113 46.1154777355471,4.64925963537261 46.1150285298727,4.64942464275094 46.1144857215368,4.64992351307081 46.113847992501,4.65008445208974 46.1131701393689,4.64988216348529 46.112902874022,4.64909871496878 46.1126890866462,4.64748190637512 46.1114606109367,4.64688347373496 46.1109378906082,4.64678825770997 46.1103538269874,4.64676800832316 46.1096786072962,4.6469262739592 46.1089107291962,4.64676634227524 46.1083276044875,4.64561326955 46.1083082996695,4.64510091391953 46.1084958632612,4.64478675718949 46.1088156553584,4.64469318214833 46.1095825927607,4.64360129139621 46.1098776200033,4.64295435465065 46.1098959922428,4.64262805835042 46.109810646119,4.64183929858335 46.1094167498296,4.64030982339339 46.1085021513732,4.6403031003191 46.1082770777399,4.64059492251216 46.1076423820517,4.64052751493834 46.1075532879823,4.63994801109059 46.1076607371618,4.63932183683775 46.1079399871424,4.6386115462773 46.1080042840332,4.63800539443475 46.1076527597161,4.6377014599659 46.107882315924,4.63744392880803 46.1079310653958,4.63709960958394 46.1076748339981,4.63605473167312 46.1073746603551,4.63565998920679 46.1071641856026,4.63487158544662 46.1067792438087,4.63388770345092 46.1063520766249,4.63252884753534 46.1055069746667,4.63204791179368 46.1050095093787,4.63140872809935 46.1044152418954,4.63084732458065 46.103387526487,4.63043541166599 46.1030331719719,4.62912673457342 46.1025655961709,4.6276266127865 46.1021908192386,4.62571090984135 46.1013356090419,4.62460283582732 46.1010812717165,4.62446808888202 46.1009030644913,4.62443544171894 46.1002370287489,4.62326933872213 46.100208679229,4.62329449689634 46.0993076398694,4.62316241922432 46.0992194609745,4.62290784207601 46.0993672103795,4.62251959063377 46.0993727616246,4.6223214759158 46.0992404918723,4.62198729871931 46.098884996624,4.62176428281255 46.0983477761712,4.62163114665433 46.0982235835161,4.62059848694432 46.0983284022039,4.62031840957192 46.0976118581523,4.61970611766629 46.097044164018,4.6180599271586 46.094779923467,4.61638330584715 46.0932366367576,4.61609725611548 46.0927543446596,4.61629675993031 46.0911753163667,4.61653307828325 46.0908477058926,4.61665452672203 46.0905757721889)))");
        $result = $documentIndex->search($documentSearch);
        $this->assertNotNull($result);
        $this->assertInstanceOf(SearchResult::class, $result);
        $this->assertEquals(1, $result->getTotal());
        $item = $result->getItems();
        $this->assertEquals($item[0]['title'], 'PLU de QUINCIE-EN-BEAUJOLAIS (69162)');
    }

      /**
     * search(default) - Recherche avec geoshape et title
     */
    public function testSearchGeofilterAndTitle(){
        $documentIndex = $this->getDocumentIndex();
        $result = $documentIndex->findAll();
        $this->assertNotNull($result);
        $this->assertEquals(105,$result->getTotal());
        $documentSearch = new DocumentSearch();
        $documentSearch->setTitle("en");
        $documentSearch->setGeometry("MULTIPOLYGON(((4.61665452672203 46.0905757721889,4.61660210931025 46.0892345081797,4.61626935442555 46.0889240109783,4.613794695769 46.0870858231449,4.61359003535329 46.0867284626531,4.6132443739722 46.0864181405478,4.61226102476257 46.0859907855272,4.61135136162513 46.0858686060566,4.61017527920187 46.0854890040961,4.60950249182586 46.0850572180404,4.60838427806916 46.0844426010884,4.60753301784512 46.0841034012124,4.60686132148717 46.0837076116026,4.6060381473481 46.0825573944437,4.6055087955693 46.0821595821679,4.60392782373667 46.0816505445819,4.60274400380621 46.0810007742705,4.60202483065046 46.0807497357496,4.59994313878259 46.0799324768121,4.5996572094565 46.0798914749924,4.59899269565951 46.0797387211559,4.59824574421415 46.0798663339511,4.59675755843386 46.079427945061,4.5917762450772 46.0794799312619,4.59155615558331 46.0799243487723,4.59116970219385 46.0804341462591,4.59109921641903 46.081128652876,4.59138055301751 46.0814579560012,4.59126291101386 46.0818649088223,4.59051522486691 46.0824157965064,4.58954645033233 46.0824834135927,4.5881830309543 46.082331379283,4.5874041605206 46.0822522121044,4.58648967503324 46.0819587748084,4.58608210748972 46.0817393052819,4.58530220935568 46.0816241113414,4.58530610606276 46.0817591576138,4.58507587451362 46.0823027772162,4.58420263493561 46.0829904770003,4.58369835116685 46.0834568593332,4.58353019271567 46.0839095418998,4.58399964273064 46.0844794184624,4.58394533388841 46.084840445053,4.58401274413161 46.0862805776151,4.58408133195939 46.0864147207381,4.58509169575108 46.0873373087367,4.58657056725121 46.0887937411961,4.58664436514753 46.0891079443345,4.58679580083445 46.0894210617689,4.58744797863498 46.089592074143,4.5880409242519 46.0930873903803,4.58833349805177 46.0938038330517,4.58941919347112 46.0950855994736,4.58959411080434 46.0962089893496,4.5899280620659 46.0965645799832,4.59002134647729 46.0971036762045,4.5905387372911 46.0970874193956,4.59141894740703 46.097975751992,4.59209316272578 46.0989029949639,4.59254645462726 46.1002476437261,4.59250654414283 46.1011038424581,4.5920291996693 46.1020562450518,4.59093329565357 46.1035577205305,4.59055570192389 46.1039322880102,4.58969000531369 46.1048901212159,4.58917749072617 46.105077432406,4.58712394862025 46.1052592795794,4.58699711810054 46.1053511200516,4.58675256036183 46.1058499080677,4.58655971043393 46.1058976373794,4.58541190847675 46.10605778254,4.58529546903957 46.1065097440725,4.58547423737499 46.1077681857702,4.58491510291716 46.1081362623256,4.58381139185402 46.1098269138601,4.58480789081891 46.1102543341671,4.58527394050058 46.1106981617079,4.58548214525417 46.1111816158326,4.58537084226928 46.1113633043792,4.58415174768667 46.111749598228,4.58383332228042 46.1119341753878,4.58377379170746 46.1121151399162,4.58398610342777 46.1122923115954,4.58423205630145 46.1122888794389,4.58438094440259 46.1125119689995,4.58448719119319 46.1135012229974,4.58437852180316 46.1142232755934,4.58408211892411 46.1147227802969,4.58363941427266 46.1150892246453,4.58294969837423 46.1154230848714,4.58230501123602 46.1155221391756,4.58204869217138 46.1156157783371,4.5816774386338 46.1162153929794,4.58157518952306 46.116712185481,4.58171217026573 46.1169714711505,4.582591258782 46.1178148559108,4.58266507291123 46.1181290611814,4.58192458877346 46.118949983516,4.58153749147604 46.1190004099572,4.5815517552719 46.119495579184,4.58121232725002 46.1203019022349,4.58075584801602 46.1210918404569,4.58037574280425 46.1218356801596,4.57990136169385 46.1220044024963,4.57965718849071 46.1229715150453,4.57944900714001 46.1247397209536,4.57922786257338 46.1260577723745,4.57900929727482 46.1270155200625,4.57873530253545 46.1282982782618,4.57840483929546 46.1294197002579,4.58050470124978 46.1317142167272,4.58188496327129 46.1337575285841,4.58251051161884 46.1347845819682,4.58345698722511 46.1357080844632,4.58385069551317 46.1358827281033,4.58449795811816 46.1358646926903,4.5858109505568 46.136467827946,4.58688597747926 46.1373534811344,4.5873649645502 46.1377881154051,4.58750749381463 46.1382364578989,4.58790774502217 46.1386361637798,4.58968969304021 46.1393227650337,4.59128237431899 46.1401831181531,4.5915622898497 46.1408997321359,4.59172695226512 46.1416629942378,4.59205988802587 46.1419735625083,4.59422637232569 46.1425105967733,4.59500872428606 46.1426797472075,4.59781385185902 46.1433428445058,4.60041557309934 46.1436935044505,4.60055936062068 46.143736511977,4.60087021459964 46.1437321311895,4.6009931708866 46.1435052301265,4.60185638866406 46.1424482796047,4.60231364944613 46.1425769307494,4.60281463705247 46.1419844249313,4.60337767866576 46.1417423031376,4.60421691187819 46.141640385519,4.60497927200819 46.1411252382965,4.60530042904664 46.1410306322504,4.60566944024883 46.140800247764,4.60614096520004 46.1409737154669,4.60685172037692 46.1409096218562,4.60709384552102 46.1407710950696,4.60746656963059 46.1402254162357,4.60791432944396 46.1400299366276,4.60899696377216 46.1398344696482,4.60990593146594 46.1399026496359,4.61068301016938 46.13989163213,4.61151004124841 46.139375522659,4.61157083174531 46.1392395588641,4.61212613749963 46.138736306743,4.61282759696057 46.1383570708603,4.61318729686895 46.13781155709,4.61414669242776 46.1373926216702,4.61612201332889 46.13671604313,4.61731946699044 46.1360234894838,4.61972138884754 46.1344400939583,4.62034663618352 46.1341159376068,4.6204721483775 46.1339790451313,4.62116950077012 46.1334647129345,4.62205638252289 46.1332268793298,4.62275770298086 46.1328475820025,4.62359942723493 46.1328355508814,4.62391757377981 46.1326418594565,4.62527727650045 46.1326224075822,4.62557980013549 46.1323388671423,4.62569329627572 46.1317968353054,4.62605682582536 46.1313863251027,4.62650338025453 46.1311547602513,4.62694325986878 46.1306981194962,4.62750474463227 46.1304108631333,4.628861452132 46.1302923357355,4.63031330305459 46.1294518823291,4.63134519184689 46.1293019606475,4.63191958797024 46.1290144964093,4.63256568267069 46.128960175255,4.63281796089346 46.1287313778451,4.63298986751285 46.1284136676495,4.63337296558209 46.1282280215602,4.63369373029245 46.1281243322212,4.63407414399527 46.1278486542493,4.63392367255754 46.1275806153324,4.63365800783691 46.127359267631,4.63378347139277 46.1272223603939,4.6337106921688 46.1269532033386,4.63290237487046 46.1263433607712,4.63126273467268 46.1256553909116,4.63138820030766 46.1255184863075,4.63220615531899 46.125146459097,4.63372523596481 46.124395060756,4.63474736919493 46.1239210017998,4.63538401445325 46.1235515613082,4.64096558163129 46.1209130919052,4.64590362605383 46.1184277807118,4.64654148252256 46.1181032921963,4.64767855049631 46.1175824121769,4.64818422563714 46.117169763982,4.64824084674815 46.1168987365653,4.64789885279181 46.1167235643478,4.6478934486387 46.1165435058797,4.6485889711516 46.115983990238,4.64934464473713 46.1157028085588,4.64933788375113 46.1154777355471,4.64925963537261 46.1150285298727,4.64942464275094 46.1144857215368,4.64992351307081 46.113847992501,4.65008445208974 46.1131701393689,4.64988216348529 46.112902874022,4.64909871496878 46.1126890866462,4.64748190637512 46.1114606109367,4.64688347373496 46.1109378906082,4.64678825770997 46.1103538269874,4.64676800832316 46.1096786072962,4.6469262739592 46.1089107291962,4.64676634227524 46.1083276044875,4.64561326955 46.1083082996695,4.64510091391953 46.1084958632612,4.64478675718949 46.1088156553584,4.64469318214833 46.1095825927607,4.64360129139621 46.1098776200033,4.64295435465065 46.1098959922428,4.64262805835042 46.109810646119,4.64183929858335 46.1094167498296,4.64030982339339 46.1085021513732,4.6403031003191 46.1082770777399,4.64059492251216 46.1076423820517,4.64052751493834 46.1075532879823,4.63994801109059 46.1076607371618,4.63932183683775 46.1079399871424,4.6386115462773 46.1080042840332,4.63800539443475 46.1076527597161,4.6377014599659 46.107882315924,4.63744392880803 46.1079310653958,4.63709960958394 46.1076748339981,4.63605473167312 46.1073746603551,4.63565998920679 46.1071641856026,4.63487158544662 46.1067792438087,4.63388770345092 46.1063520766249,4.63252884753534 46.1055069746667,4.63204791179368 46.1050095093787,4.63140872809935 46.1044152418954,4.63084732458065 46.103387526487,4.63043541166599 46.1030331719719,4.62912673457342 46.1025655961709,4.6276266127865 46.1021908192386,4.62571090984135 46.1013356090419,4.62460283582732 46.1010812717165,4.62446808888202 46.1009030644913,4.62443544171894 46.1002370287489,4.62326933872213 46.100208679229,4.62329449689634 46.0993076398694,4.62316241922432 46.0992194609745,4.62290784207601 46.0993672103795,4.62251959063377 46.0993727616246,4.6223214759158 46.0992404918723,4.62198729871931 46.098884996624,4.62176428281255 46.0983477761712,4.62163114665433 46.0982235835161,4.62059848694432 46.0983284022039,4.62031840957192 46.0976118581523,4.61970611766629 46.097044164018,4.6180599271586 46.094779923467,4.61638330584715 46.0932366367576,4.61609725611548 46.0927543446596,4.61629675993031 46.0911753163667,4.61653307828325 46.0908477058926,4.61665452672203 46.0905757721889)))");
        $result = $documentIndex->search($documentSearch);
        $this->assertNotNull($result);
        $this->assertInstanceOf(SearchResult::class, $result);
        $this->assertEquals(1, $result->getTotal());
        $item = $result->getItems();
        $this->assertEquals($item[0]['title'], 'PLU de QUINCIE-EN-BEAUJOLAIS (69162)');
    }
}